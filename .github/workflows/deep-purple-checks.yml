name: Deep Purple E2E Test Runner (Frontend Apps Only)

on:
  workflow_call:
    secrets:
      JENKINS_OKTA_USERNAME:
        required: true
      JENKINS_USER_TOKEN:
        required: true
    inputs:
      app:
        type: string
        default: ""
        required: false
      runner:
        description: "Self-hosted GHA runner"
        type: string
        required: false
        default: "ci-universal"

jobs:
  run-deep-purple-tests:
    name: Run Deep Purple Tests Against Changes
    runs-on: [self-hosted, "${{ inputs.runner }}"]

    steps:
      - name: Check out Git repository
        uses: actions/checkout@v5

      - name: Extract app name from package.json
        run: |
          APP="${{ inputs.app }}"
          if [ -z "${APP}" ]; then
            echo "APP_NAME=$(jq -r '.name' package.json | sed 's/@typeform\///')" >> $GITHUB_ENV
          else
            echo "APP_NAME=${APP}" >> $GITHUB_ENV
          fi

      - name: Print extracted app name
        run: echo "Extracted APP_NAME is ${{ env.APP_NAME }}"

      - name: Run Deep Purple tests
        id: 'deep-purple-tests'
        uses: Typeform/deep-purple-action@v1
        env:
          JENKINS_OKTA_USERNAME: ${{ secrets.JENKINS_OKTA_USERNAME }}
          JENKINS_USER_TOKEN: ${{ secrets.JENKINS_USER_TOKEN }}
        with:
          preview-app-name: ${{ env.APP_NAME }}
          preview-app-version: ${{ github.sha }}
          gha-repo: ${{ github.repository }}
          gha-event-name: ${{ github.event_name }}
          gha-ref-name: ${{ github.ref_name }}
          gha-actor: ${{ github.triggering_actor }}
          gha-workflow-run-url: "${{github.server_url}}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: Find previous Deep Purple run comment
        if: ${{ !contains(github.ref, 'refs/heads/master') && !contains(github.ref, 'refs/heads/main') && (success() || failure()) }}
        uses: peter-evans/find-comment@v4
        id: previous-deep-purple-comment
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.number }}
          body-includes: '## Deep Purple'

      - name: Publish Deep Purple comment
        if: ${{ !contains(github.ref, 'refs/heads/master') && !contains(github.ref, 'refs/heads/main') && (success() || failure()) }}
        uses: peter-evans/create-or-update-comment@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          comment-id: ${{ steps.previous-deep-purple-comment.outputs.comment-id }}
          issue-number: ${{ github.event.number }}
          edit-mode: replace
          body: |
            ## Deep Purple

            ${{ steps.deep-purple-tests.outputs.help-message }}
