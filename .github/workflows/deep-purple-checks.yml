name: Deep Purple E2E Test Runner (Frontend Apps Only)

on:
  workflow_call: # Allows this workflow to be called from other workflows

jobs:
  run-deep-purple-tests:
    name: Run Deep Purple Tests Against Changes
    runs-on: [self-hosted, ci-universal]

    env:
      DOCKER_IMAGE: 567716553783.dkr.ecr.us-east-1.amazonaws.com/deep-purple:dev-13682498004

    steps:
      - name: Check out Git repository
        uses: actions/checkout@v2

      - name: Extract app name from package.json
        run: |
          echo "APP_NAME=$(grep '"name":' package.json | sed 's/.*"@typeform\/\(.*\)",/\1/')" >> $GITHUB_ENV

      - name: Print extracted app name
        run: echo "Extracted APP_NAME is ${{ env.APP_NAME }}"

      - name: Pull docker image
        run: docker pull ${{ env.DOCKER_IMAGE }}

      - name: Create test-results directory
        run: mkdir -p ${{ github.workspace }}/test-results

      - name: Run Deep Purple tests
        run: |
          docker run --name deep-purple-container \
            -v ${{ github.workspace }}/test-results:/home/pwuser/test-results \
            -a stdin -a stdout \
            -e TERM=xterm-256color \
            -e FORCE_COLOR=1 \
            -e CLOUDFLARE_BYPASS_TOKEN="${{ secrets.CLOUDFLARE_BYPASS_TOKEN }}" \
            -e PROD_BASIC_PASSWORD="${{ secrets.PROD_BASIC_PASSWORD }}" \
            -e PROD_PAID_PASSWORD="${{ secrets.PROD_PAID_PASSWORD }}" \
            -e PREVIEW_APP_NAME="${{ env.APP_NAME }}" \
            -e PREVIEW_APP_VERSION="${{ github.sha }}" \
            -e AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID }}" \
            -e AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY }}" \
            -e AWS_REGION="us-east-1" \
            -e S3_BUCKET_NAME="deep-purple-us-results" \
            -e NO_AUTH=true \
            -e SEND_NOTIFICATIONS=false \
            -e GLOBAL_TEARDOWN=false \
            ${{ env.DOCKER_IMAGE }} \
            npx playwright test test/demo_page.test.ts
          sleep 5  # Give container some time to start

      - name: Post test report to PR comments
        uses: ctrf-io/github-test-reporter@v1
        with:
          report-path: "${{ github.workspace }}/test-results/*.json"
          github-report: false
          pull-request-report: true
          pull-request: true
          failed-report: false
          ai-report: false
          update-comment: false
          overwrite-comment: true
          exit-on-fail: false
          title: "Deep Purple Results"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        if: always()
