# ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
# ‚ö†Ô∏è  THIS FILE IS A COPY OF frontend-deploy-workflow-v1.yml
# ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
#
# This is the "default" workflow that projects use when they don't specify a version.
# It is intentionally a copy of the latest stable version to avoid delegation complexity.
#
# üìã Version History:
#   - 2026-02-04: Synced from frontend-deploy-workflow-v1.yml (original, no testing)
#
# üîÑ To promote a new version to default:
#   1. Copy the new version file content here (e.g., from frontend-deploy-workflow-v2.yml)
#   2. Update the version history above
#   3. Keep the versioned files unchanged for explicit version pinning
#
# üìå Projects can pin to specific versions:
#   - frontend-deploy-workflow-v1.yml (original, no testing support)
#   - frontend-deploy-workflow-v2.yml (with testing support)
#   - frontend-deploy-workflow.yml (this file - currently v1)
#
# üìñ See: ../ci-consolidation/workflow-versioning-strategy.md
# ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

name: Frontend Deploy Workflow

env:
  WORKFLOW_VERSION: 'v2'
  WORKFLOW_FILE: 'frontend-deploy-workflow-v2'

on:
  workflow_call:
    inputs:
      # Project identification
      app-name:
        description: 'Application name (e.g., demo-app, app-shell)'
        type: string
        required: true
      
      # Node configuration
      node-version:
        description: 'Node.js version (ignored if use-asdf is true)'
        type: string
        default: '20'
      use-asdf:
        description: 'Use asdf-vm for version management (reads from .tool-versions)'
        type: boolean
        default: false
      
      # Cache configuration
      # Same options as PR workflow - see frontend-pr-workflow.yml for detailed comments
      cache-mode:
        description: 'Cache strategy: full, node_modules-only, or yarn-cache-only'
        type: string
        default: 'full'
      disable-restore-keys:
        description: 'Disable restore-keys to avoid restoring stale caches'
        type: boolean
        default: false
      
      # Runner configuration
      runner:
        description: 'Runner for build/deploy jobs'
        type: string
        default: '["self-hosted", "ci-universal"]'
      e2e-runner:
        description: 'Runner for E2E/integration tests'
        type: string
        default: '["self-hosted", "ci-e2e"]'
      
      # Build configuration
      build-command:
        description: 'Production build command'
        type: string
        default: 'yarn dist'
      clean-command:
        description: 'Clean command before build'
        type: string
        default: 'yarn clean'
      build-output-dir:
        description: 'Build output directory name (dist, build, lib, etc.)'
        type: string
        default: 'dist'
      
      # Deploy configuration
      deploy-command:
        description: 'Production deploy command'
        type: string
        default: 'yarn deploy'
      cdn-bucket:
        description: 'S3 bucket for production assets'
        type: string
        required: true
      cloudfront-dist:
        description: 'CloudFront distribution ID'
        type: string
        required: true
      cdn-url:
        description: 'Public CDN URL'
        type: string
        required: true
      
      # AWS configuration
      aws-region:
        description: 'AWS region'
        type: string
        default: 'us-east-1'
      aws-account:
        description: 'AWS account (prod/staging)'
        type: string
        default: 'prod'
      
      # Jarvis configuration
      jarvis-branch:
        description: 'Jarvis branch to use (empty = npm version)'
        type: string
        default: ''
      jarvis-datadog-enabled:
        description: 'Enable Jarvis Datadog logging'
        type: boolean
        default: true
      jarvis-datadog-service:
        description: 'Datadog service name'
        type: string
        required: true
      jarvis-datadog-env:
        description: 'Datadog environment'
        type: string
        default: 'production'
      
      # Test configuration
      pre-test-command:
        description: 'Command to run before tests (e.g., GraphQL codegen)'
        type: string
        default: ''
      
      # Unit tests
      run-unit-tests:
        description: 'Run unit tests before deployment'
        type: boolean
        default: false
      unit-test-command:
        description: 'Unit test command'
        type: string
        default: 'yarn test:ci --coverage'
      unit-test-timeout:
        description: 'Unit test timeout (minutes)'
        type: number
        default: 30
      
      # Integration tests (for self-managed servers: Playwright, CodeceptJS, etc.)
      run-integration-tests:
        description: 'Run integration tests with self-managed servers (Playwright webServer, etc.). Do NOT use with run-cypress-functional.'
        type: boolean
        default: false
      integration-test-command:
        description: 'Integration test command (framework manages its own server)'
        type: string
        default: 'yarn test:integration'
      integration-test-framework:
        description: 'Integration test framework: playwright (most common), codeceptjs, cypress (self-managed), puppeteer, none'
        type: string
        default: 'none'
      integration-test-timeout:
        description: 'Integration test timeout (minutes)'
        type: number
        default: 20
      
      # Cypress functional tests
      run-cypress-functional:
        description: 'Run Cypress functional tests before deployment'
        type: boolean
        default: false
      cypress-functional-command:
        description: 'Cypress functional test command'
        type: string
        default: 'yarn test:functional'
      cypress-functional-start:
        description: 'Command to start server for functional tests'
        type: string
        default: 'yarn start:ci'
      cypress-functional-wait-on:
        description: 'URL to wait for before running functional tests'
        type: string
        default: 'http://0.0.0.0:9000'
      
      # Cypress visual tests
      run-cypress-visual:
        description: 'Run Cypress visual regression tests before deployment'
        type: boolean
        default: false
      cypress-visual-command:
        description: 'Cypress visual test command'
        type: string
        default: 'yarn test:visual'
      cypress-visual-start:
        description: 'Command to start server for visual tests'
        type: string
        default: 'yarn start:ci'
      cypress-visual-wait-on:
        description: 'URL to wait for before running visual tests'
        type: string
        default: 'http://localhost:9000'
      
      # Cypress configuration
      cypress-runner:
        description: 'Runner for Cypress tests (defaults to e2e-runner)'
        type: string
        default: ''
      cypress-timeout:
        description: 'Cypress test timeout (minutes)'
        type: number
        default: 20
      
      # SonarCloud configuration
      run-sonarcloud:
        description: 'Run SonarCloud analysis'
        type: boolean
        default: true
      sonarcloud-timeout:
        description: 'SonarCloud job timeout (minutes)'
        type: number
        default: 10
      sonarcloud-wait-for-tests:
        description: 'Wait for unit tests to complete before running SonarCloud'
        type: boolean
        default: true
      
      # Timeout configuration
      build-timeout:
        description: 'Build job timeout (minutes)'
        type: number
        default: 15
      deploy-timeout:
        description: 'Deploy job timeout (minutes)'
        type: number
        default: 10
      
      # Revert mode
      revert-mode:
        description: 'Skip tests and linting (for emergency reverts)'
        type: boolean
        default: false
      
      # Slack notifications
      slack-channel:
        description: 'Slack channel for deployment notifications (e.g., tfprod-deploy)'
        type: string
        default: 'poc-tfprod-admin-deploy'
    
    secrets:
      GH_TOKEN:
        required: true
      SONAR_CLOUD_TOKEN:
        required: false
      DATADOG_API_KEY:
        required: false
      LINEARB_API_KEY:
        required: false
      DATADOG_API_KEY_FRONTEND_METRICS:
        required: false
      DATADOG_JS_SOURCEMAPS_US:
        required: false
      DATADOG_JS_SOURCEMAPS_EU:
        required: false
      SLACK_OAUTH_TOKEN:
        required: false
      # Cypress secrets
      CYPRESS_RECORD_KEY:
        required: false
      # Visual Regression Tracker secrets
      VRT_APIURL:
        required: false
      VRT_APIKEY:
        required: false
      VRT_PROJECT:
        required: false

permissions:
  id-token: write
  contents: read

# Concurrency control: Only one deploy at a time per workflow
concurrency:
  group: 'deploy-${{ github.workflow }}'
  cancel-in-progress: false

jobs:
  # Job 1: Build for Production
  build:
    name: üèóÔ∏è Build
    runs-on: ${{ fromJSON(inputs.runner) }}
    timeout-minutes: ${{ inputs.build-timeout }}
    outputs:
      artifact-name: ${{ steps.artifact-info.outputs.name }}
      workflow-version: ${{ steps.artifact-info.outputs.version }}
    
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v6
      
      - name: Setup Node with Cache
        uses: Typeform/.github/shared-actions/setup-node-with-cache@v1
        with:
          node-version: ${{ inputs.node-version }}
          use-asdf: ${{ inputs.use-asdf }}
          cache-mode: ${{ inputs.cache-mode }}
          disable-restore-keys: ${{ inputs.disable-restore-keys }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
      
      - name: Setup Jarvis
        uses: Typeform/.github/shared-actions/setup-jarvis@v1
        with:
          jarvis-branch: ${{ inputs.jarvis-branch }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
      
      - name: Clean dist directory
        run: ${{ inputs.clean-command }}
      
      - name: Build production assets
        run: ${{ inputs.build-command }}
        env:
          PUBLIC_CDN_URL: ${{ inputs.cdn-url }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          JARVIS_DATADOG_LOGS_ENABLED: ${{ inputs.jarvis-datadog-enabled }}
          JARVIS_DATADOG_API_KEY: ${{ secrets.DATADOG_API_KEY || secrets.DATADOG_API_KEY_FRONTEND_METRICS }}
          JARVIS_DATADOG_SITE: datadoghq.com
          JARVIS_DATADOG_SERVICE: ${{ inputs.jarvis-datadog-service }}
          JARVIS_DATADOG_ENV: ${{ inputs.jarvis-datadog-env }}
      
      - name: Set artifact info
        id: artifact-info
        run: |
          echo "name=build-${{ github.run_id }}" >> $GITHUB_OUTPUT
          echo "version=${{ env.WORKFLOW_VERSION }}" >> $GITHUB_OUTPUT
          echo "üì¶ Build artifact: build-${{ github.run_id }}"
          echo "üìã Workflow version: ${{ env.WORKFLOW_VERSION }} (${{ env.WORKFLOW_FILE }})"
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: build-${{ github.run_id }}
          path: ${{ inputs.build-output-dir }}
          retention-days: 1
  
  # Job 2: Unit Tests (runs in parallel with other tests)
  unit-tests:
    name: üß™ Unit Tests
    if: inputs.run-unit-tests
    needs: build
    runs-on: ${{ fromJSON(inputs.runner) }}
    timeout-minutes: ${{ inputs.unit-test-timeout }}
    
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Required for SonarCloud
      
      - name: Setup Node with Cache
        uses: Typeform/.github/shared-actions/setup-node-with-cache@v1
        with:
          node-version: ${{ inputs.node-version }}
          use-asdf: ${{ inputs.use-asdf }}
          cache-mode: ${{ inputs.cache-mode }}
          disable-restore-keys: ${{ inputs.disable-restore-keys }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
      
      - name: Setup Jarvis
        uses: Typeform/.github/shared-actions/setup-jarvis@v1
        with:
          jarvis-branch: ${{ inputs.jarvis-branch }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
      
      - name: Run pre-test command
        if: inputs.pre-test-command != ''
        run: ${{ inputs.pre-test-command }}
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
      
      - name: Run unit tests
        run: ${{ inputs.unit-test-command }}
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
      
      - name: Upload coverage
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: coverage-${{ github.run_id }}
          path: coverage/
          retention-days: 7
  
  # Job 3: Integration Tests (runs in parallel with unit tests)
  integration-tests:
    name: üîó Integration Tests
    if: inputs.run-integration-tests
    needs: build
    runs-on: ${{ fromJSON(inputs.e2e-runner) }}
    timeout-minutes: ${{ inputs.integration-test-timeout }}
    
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v6
      
      - name: Setup Node with Cache
        uses: Typeform/.github/shared-actions/setup-node-with-cache@v1
        with:
          node-version: ${{ inputs.node-version }}
          use-asdf: ${{ inputs.use-asdf }}
          cache-mode: ${{ inputs.cache-mode }}
          disable-restore-keys: ${{ inputs.disable-restore-keys }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
      
      - name: Setup Jarvis
        uses: Typeform/.github/shared-actions/setup-jarvis@v1
        with:
          jarvis-branch: ${{ inputs.jarvis-branch }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
      
      - name: Setup Playwright
        if: inputs.integration-test-framework == 'playwright'
        uses: Typeform/.github/shared-actions/setup-playwright@v1
      
      - name: Run pre-test command
        if: inputs.pre-test-command != ''
        run: ${{ inputs.pre-test-command }}
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
      
      - name: Download Build Artifacts
        uses: Typeform/.github/shared-actions/download-build-artifacts@v1
        with:
          artifact-name: ${{ needs.build.outputs.artifact-name }}
          output-dir: ${{ inputs.build-output-dir }}
      
      - name: Run integration tests
        run: ${{ inputs.integration-test-command }}
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: integration-test-results-${{ github.run_id }}
          path: playwright-report/
          retention-days: 7
  
  # Job 4: Cypress Functional Tests (runs in parallel with other tests)
  cypress-functional:
    name: ‚öôÔ∏è Cypress Functional
    if: inputs.run-cypress-functional
    needs: build
    runs-on: ${{ fromJSON(inputs.cypress-runner != '' && inputs.cypress-runner || inputs.e2e-runner) }}
    timeout-minutes: ${{ inputs.cypress-timeout }}
    
    steps:
      - name: Run Cypress Functional Tests
        uses: Typeform/.github/shared-actions/run-cypress-functional@v1
        with:
          node-version: ${{ inputs.node-version }}
          use-asdf: ${{ inputs.use-asdf }}
          jarvis-branch: ${{ inputs.jarvis-branch }}
          pre-test-command: ${{ inputs.pre-test-command }}
          test-command: ${{ inputs.cypress-functional-command }}
          start-command: ${{ inputs.cypress-functional-start }}
          wait-on-url: ${{ inputs.cypress-functional-wait-on }}
          artifact-name: 'cypress-functional-results-${{ github.run_id }}'
          artifact-retention-days: '7'
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
  
  # Job 5: Cypress Visual Tests (runs in parallel with other tests)
  cypress-visual:
    name: üé® Cypress Visual
    if: inputs.run-cypress-visual
    needs: build
    runs-on: ${{ fromJSON(inputs.cypress-runner != '' && inputs.cypress-runner || inputs.e2e-runner) }}
    timeout-minutes: ${{ inputs.cypress-timeout }}
    
    steps:
      - name: Run Cypress Visual Tests
        uses: Typeform/.github/shared-actions/run-cypress-visual@v1
        with:
          node-version: ${{ inputs.node-version }}
          use-asdf: ${{ inputs.use-asdf }}
          jarvis-branch: ${{ inputs.jarvis-branch }}
          pre-test-command: ${{ inputs.pre-test-command }}
          test-command: ${{ inputs.cypress-visual-command }}
          start-command: ${{ inputs.cypress-visual-start }}
          wait-on-url: ${{ inputs.cypress-visual-wait-on }}
          vrt-branch-name: ${{ github.head_ref || github.ref_name }}
          vrt-build-id: ${{ github.sha }}
          artifact-name: 'cypress-visual-results-${{ github.run_id }}'
          artifact-retention-days: '7'
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
          VRT_APIURL: ${{ secrets.VRT_APIURL }}
          VRT_APIKEY: ${{ secrets.VRT_APIKEY }}
          VRT_PROJECT: ${{ secrets.VRT_PROJECT }}
  
  # Job 6: SonarCloud Analysis (waits for unit tests if enabled)
  sonarcloud:
    name: üîç SonarCloud
    if: inputs.run-sonarcloud
    needs: [build, unit-tests]
    permissions:
      contents: read
    uses: Typeform/.github/.github/workflows/sonarcloud-scan.yml@v1
    with:
      app-name: ${{ inputs.app-name }}
      node-version: ${{ inputs.node-version }}
      use-asdf: ${{ inputs.use-asdf }}
      runner: ${{ inputs.runner }}
      coverage-artifact-name: ${{ inputs.run-unit-tests && format('coverage-{0}', github.run_id) || '' }}
      timeout: ${{ inputs.sonarcloud-timeout }}
    secrets:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      SONAR_CLOUD_TOKEN: ${{ secrets.SONAR_CLOUD_TOKEN }}
  
  # Job 7: Deploy to Production (only if all enabled tests pass)
  deploy:
    name: üöÄ Deploy to Production
    needs: 
      - build
      - unit-tests
      - integration-tests
      - cypress-functional
      - cypress-visual
    # Deploy only if:
    # - Build succeeded
    # - All enabled tests succeeded (or were skipped if disabled)
    if: |
      always() &&
      needs.build.result == 'success' &&
      (inputs.run-unit-tests == false || needs.unit-tests.result == 'success') &&
      (inputs.run-integration-tests == false || needs.integration-tests.result == 'success') &&
      (inputs.run-cypress-functional == false || needs.cypress-functional.result == 'success') &&
      (inputs.run-cypress-visual == false || needs.cypress-visual.result == 'success')
    runs-on: ${{ fromJSON(inputs.runner) }}
    timeout-minutes: ${{ inputs.deploy-timeout }}
    permissions:
      id-token: write
      contents: write
    
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GH_TOKEN }}
          fetch-depth: 0
      
      - name: Configure Git
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"
      
      - name: Setup Node with Cache
        uses: Typeform/.github/shared-actions/setup-node-with-cache@v1
        with:
          node-version: ${{ inputs.node-version }}
          use-asdf: ${{ inputs.use-asdf }}
          cache-mode: ${{ inputs.cache-mode }}
          disable-restore-keys: ${{ inputs.disable-restore-keys }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
      
      - name: Download Build Artifacts
        uses: Typeform/.github/shared-actions/download-build-artifacts@v1
        with:
          artifact-name: ${{ needs.build.outputs.artifact-name }}
          output-dir: ${{ inputs.build-output-dir }}
      
      - name: Setup Jarvis
        uses: Typeform/.github/shared-actions/setup-jarvis@v1
        with:
          jarvis-branch: ${{ inputs.jarvis-branch }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
      
      - name: AWS auth
        uses: Typeform/.github-private/actions/aws-auth@aws-auth-0.0.2
        with:
          region: ${{ inputs.aws-region }}
          account: ${{ inputs.aws-account }}
          output_credentials: true
      
      - name: Deploy to production
        run: ${{ inputs.deploy-command }}
        env:
          # Jarvis debug logging
          DEBUG: jarvis
          # GitHub
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          # AWS configuration
          AWS_REGION: ${{ inputs.aws-region }}
          AWS_ASSETS_BUCKET: ${{ inputs.cdn-bucket }}
          AWS_CLOUDFRONT_DIST: ${{ inputs.cloudfront-dist }}
          PUBLIC_CDN_URL: ${{ inputs.cdn-url }}
          # Jarvis Datadog logging
          JARVIS_DATADOG_LOGS_ENABLED: ${{ inputs.jarvis-datadog-enabled }}
          JARVIS_DATADOG_API_KEY: ${{ secrets.DATADOG_API_KEY || secrets.DATADOG_API_KEY_FRONTEND_METRICS }}
          JARVIS_DATADOG_SITE: datadoghq.com
          JARVIS_DATADOG_SERVICE: ${{ inputs.jarvis-datadog-service }}
          JARVIS_DATADOG_ENV: ${{ inputs.jarvis-datadog-env }}
          JARVIS_DATADOG_TAGS: 'workflow_version:${{ env.WORKFLOW_VERSION }},workflow_file:${{ env.WORKFLOW_FILE }}'
          # Production-specific secrets
          LINEARB_API_KEY: ${{ secrets.LINEARB_API_KEY }}
          DATADOG_API_KEY_FRONTEND_METRICS: ${{ secrets.DATADOG_API_KEY_FRONTEND_METRICS }}
          DATADOG_API_KEY_US: ${{ secrets.DATADOG_JS_SOURCEMAPS_US }}
          DATADOG_API_KEY_EU: ${{ secrets.DATADOG_JS_SOURCEMAPS_EU }}
          SLACK_OAUTH_TOKEN: ${{ secrets.SLACK_OAUTH_TOKEN }}
      
      - name: Tag pipeline with workflow version
        if: inputs.jarvis-datadog-enabled
        continue-on-error: true
        run: |
          npx --yes @datadog/datadog-ci@latest tag --level pipeline \
            --tags "workflow_version:${{ env.WORKFLOW_VERSION }}" \
            --tags "workflow_file:${{ env.WORKFLOW_FILE }}"
        env:
          DATADOG_API_KEY: ${{ secrets.DATADOG_API_KEY || secrets.DATADOG_API_KEY_FRONTEND_METRICS }}
          DATADOG_SITE: datadoghq.com
      
      - name: Print deployment info
        run: |
          echo "‚úÖ Deployed to production"
          echo "üì¶ App: ${{ inputs.app-name }}"
          echo "üåê CDN: ${{ inputs.cdn-url }}"
          echo "üìù Commit: ${{ github.sha }}"
          echo "üìã Workflow: frontend-deploy-workflow-v2 (v2)"
  
  # Job 8: Slack Notifications (runs after deploy completes)
  notify-slack:
    name: üì¢ Notify Slack
    if: always() && inputs.slack-channel != '' && needs.deploy.result != 'cancelled'
    needs: [deploy]
    runs-on: ubuntu-latest
    timeout-minutes: 2
    
    steps:
      - name: Send deployment notification
        uses: Typeform/.github/shared-actions/slack-deployment-notification@v1
        with:
          slack-channel: ${{ inputs.slack-channel }}
          app-name: ${{ inputs.app-name }}
          deployment-status: ${{ needs.deploy.result }}
          cdn-url: ${{ inputs.cdn-url }}
          github-sha: ${{ github.sha }}
          github-actor: ${{ github.actor }}
          github-ref-name: ${{ github.ref_name }}
          github-repository: ${{ github.repository }}
          github-server-url: ${{ github.server_url }}
          github-run-id: ${{ github.run_id }}
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_OAUTH_TOKEN }}
